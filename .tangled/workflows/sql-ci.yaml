when:
  - event: ["push"]
    branch: ["*"]

engine: "nixery"

dependencies:
  nixpkgs:
    - nodejs
    - postgresql

environment:
  DATABASE_URL: postgresql://postgres:postgres@localhost/cartography
  SHADOW_DATABASE_URL: postgresql://postgres:postgres@localhost/shadow
  ROOT_DATABASE_URL: postgresql://postgres:postgres@localhost/postgres
  PGDATA: /usr/local/pgsql/data/

steps:
  - name: Install node modules
    command: |
      npm ci
  - name: Check graphile status
    command: |
      npx graphile-migrate status --skipDatabase
  - name: Start Postgres
    command: |
      useradd --system postgres
      su - postgres
      pg_ctl initdb -U postgres -A trust
      pg_ctl start
  - name: Run migrate
    command: |
      npx graphile-migrate migrate
  - name: Stop postgres
      su - postgres
      pg_ctl stop
